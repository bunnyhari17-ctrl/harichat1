<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hari AI - Unlimited Chats</title>
    <style>
        /* All your existing CSS styles remain the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #1f2937;
            min-height: 100vh;
            overflow: hidden;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
            z-index: 100;
            height: 60px;
        }

        .menu-btn {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 1.2em;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .profile-btn:hover {
            background: #f3f4f6;
        }

        .user-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .app-title {
            text-align: center;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .app-title .hari-text {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-title input {
            background: transparent;
            border: none;
            padding: 8px 12px;
            color: #1f2937;
            text-align: center;
            width: 200px;
            font-size: 16px;
            font-weight: 600;
            outline: none;
            transition: all 0.2s ease;
            display: none;
        }

        .app-title input:focus {
            background: #f8fafc;
            border-radius: 6px;
        }

        .new-chat-btn {
            background: #ffffff;
            border: none;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .new-chat-btn:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
        }

        .star-icon {
            font-size: 1.5em;
            display: inline-block;
            transition: transform 0.3s ease;
            color: #fbbf24;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        .new-chat-btn:hover .star-icon {
            transform: rotate(90deg);
            color: #f59e0b;
        }

        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 280px;
            background: #f8fafc;
            border-right: 1px solid #e5e7eb;
            padding: 0;
            overflow-y: auto;
            position: fixed;
            left: -280px;
            top: 60px;
            height: calc(100vh - 60px);
            transition: left 0.3s ease;
            z-index: 99;
        }

        .sidebar.visible {
            left: 0;
        }

        .history-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-header h3 {
            color: #1f2937;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 0;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .sidebar-profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .sidebar-profile-btn:hover {
            background: #f3f4f6;
        }

        .sidebar-user-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .search-container {
            padding: 0 20px 16px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .search-box {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 10px 36px 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9em;
            background: #ffffff;
            outline: none;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 0.9em;
        }

        .chat-list {
            padding: 8px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            flex: 1;
        }

        .chat-item {
            padding: 12px 16px;
            margin-bottom: 4px;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            border: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        .chat-item:hover {
            background: #f3f4f6;
        }

        .chat-item.active {
            background: #e0f2fe;
            color: #0369a1;
        }

        .chat-item.pinned {
            background: #fef3c7;
        }

        .chat-title {
            font-weight: 500;
            font-size: 0.9em;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #374151;
        }

        .chat-item.active .chat-title {
            color: #0369a1;
        }

        .chat-time {
            font-size: 0.75em;
            opacity: 0.6;
            color: #6b7280;
        }

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            background: #ffffff;
        }

        .message {
            padding: 24px 20px;
            border-bottom: 1px solid #f3f4f6;
            animation: fadeIn 0.3s ease-in;
            line-height: 1.6;
            background: #ffffff;
        }

        .user-message {
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }

        .ai-message {
            background: #ffffff;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9em;
        }

        .user-avatar {
            background: #10b981;
            color: white;
        }

        .ai-avatar {
            background: #3b82f6;
            color: white;
        }

        .sender-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #1f2937;
        }

        .message-content {
            color: #374151;
            font-size: 0.95em;
            line-height: 1.7;
        }

        .input-container {
            padding: 20px;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            position: relative;
        }

        .input-wrapper {
            max-width: 768px;
            margin: 0 auto;
            position: relative;
        }

        .input-row {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 12px;
            transition: all 0.2s ease;
        }

        .input-row:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #user-input {
            flex: 1;
            padding: 8px 4px;
            border: none;
            background: transparent;
            color: #1f2937;
            font-size: 0.95em;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.5;
            font-family: inherit;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            background: transparent;
            border: none;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            transition: all 0.2s ease;
            position: relative;
        }

        .icon-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        /* Plus symbol styling */
        .plus-icon {
            font-size: 1.3em;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .icon-btn:hover .plus-icon {
            transform: scale(1.1);
        }

        /* Voice support button styling */
        .voice-btn {
            background: transparent;
            border: none;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            transition: all 0.2s ease;
            position: relative;
        }

        .voice-btn:hover {
            background: #f3f4f6;
            color: #3b82f6;
        }

        .voice-btn.active {
            background: #3b82f6;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        #send-btn {
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #send-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        /* Voice recording indicator */
        .voice-indicator {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            z-index: 10;
        }

        .voice-indicator.visible {
            display: flex;
            animation: slideDown 0.3s ease;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translate(-50%, -10px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* Upload Options */
        .upload-options {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: #ffffff;
            border-radius: 12px;
            padding: 8px;
            border: 1px solid #e5e7eb;
            display: none;
            flex-direction: column;
            gap: 4px;
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            min-width: 160px;
        }

        .upload-options.visible {
            display: flex;
            animation: slideUp 0.2s ease;
        }

        .upload-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            color: #374151;
            border: none;
            width: 100%;
            text-align: left;
        }

        .upload-option:hover {
            background: #f3f4f6;
        }

        .upload-option .icon {
            font-size: 1.1em;
            width: 20px;
            text-align: center;
            color: #6b7280;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 98;
        }

        .sidebar-overlay.visible {
            display: block;
        }

        .no-results {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 0.9em;
        }

        .stats {
            padding: 12px 20px;
            border-top: 1px solid #e5e7eb;
            font-size: 0.8em;
            color: #6b7280;
            text-align: center;
        }

        /* Chat Context Menu */
        .chat-context-menu {
            position: absolute;
            background: #ffffff;
            border-radius: 8px;
            padding: 8px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 140px;
            display: none;
            flex-direction: column;
            gap: 4px;
        }

        .chat-context-menu.visible {
            display: flex;
            animation: slideUp 0.2s ease;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85em;
            color: #374151;
            border: none;
            width: 100%;
            text-align: left;
        }

        .context-menu-item:hover {
            background: #f3f4f6;
        }

        .context-menu-item.delete:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Profile Dropdown Menu */
        .profile-dropdown {
            position: absolute;
            top: 70px;
            right: 20px;
            background: #ffffff;
            border-radius: 12px;
            padding: 8px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
            display: none;
            flex-direction: column;
            gap: 4px;
        }

        .profile-dropdown.visible {
            display: flex;
            animation: slideUp 0.2s ease;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            color: #374151;
            border: none;
            width: 100%;
            text-align: left;
        }

        .dropdown-item:hover {
            background: #f3f4f6;
        }

        .dropdown-item.logout:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .dropdown-icon {
            font-size: 1.1em;
            width: 20px;
            text-align: center;
        }

        /* Account Settings Modal */
        .account-settings {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .account-settings.visible {
            display: flex;
        }

        .settings-container {
            background: white;
            border-radius: 12px;
            padding: 0;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-header h2 {
            font-size: 1.3em;
            font-weight: 600;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .settings-content {
            padding: 0;
            max-height: 60vh;
            overflow-y: auto;
        }

        .settings-section {
            padding: 20px;
            border-bottom: 1px solid #f3f4f6;
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section h3 {
            font-size: 1em;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
        }

        .login-form {
            padding: 0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.9em;
            color: #374151;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.2s ease;
        }

        .form-group input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .verify-btn {
            width: 100%;
            padding: 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        .verify-btn:hover {
            background: #2563eb;
        }

        .theme-options, .language-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .theme-option, .language-option {
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .theme-option:hover, .language-option:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .theme-option.active, .language-option.active {
            border-color: #3b82f6;
            background: #e0f2fe;
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* Toast Notification - Hide it */
        .toast {
            display: none !important;
        }

        /* New styles for enhanced UI */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 16px 20px;
            color: #6b7280;
            font-size: 0.9em;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingAnimation {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-top: 8px;
            border: 1px solid #e5e7eb;
        }

        .file-icon {
            font-size: 1.5em;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            font-size: 0.9em;
            margin-bottom: 2px;
        }

        .file-size {
            font-size: 0.75em;
            color: #6b7280;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Country Code Selector */
        .phone-input-container {
            display: flex;
            gap: 8px;
        }

        .country-code {
            width: 80px;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 0.95em;
        }

        .phone-number {
            flex: 1;
        }

        /* Send Code Button */
        .send-code-btn {
            width: 100%;
            padding: 10px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 12px;
        }

        .send-code-btn:hover {
            background: #059669;
        }

        .send-code-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Toast Notification - Hidden -->
    <div class="toast" id="toast">
        <span id="toast-message">‚úÖ File uploaded successfully!</span>
    </div>

    <!-- Voice Recording Indicator -->
    <div class="voice-indicator" id="voice-indicator">
        <div class="recording-dot"></div>
        Listening... Speak now
    </div>

    <!-- Account Settings Modal -->
    <div class="account-settings" id="account-settings">
        <div class="settings-container">
            <div class="settings-header">
                <h2>Account Settings</h2>
                <button class="close-btn" onclick="closeAccountSettings()">‚úï</button>
            </div>
            
            <div class="settings-content">
                <!-- Login Section -->
                <div class="settings-section">
                    <h3>Account Login</h3>
                    <div class="login-form">
                        <div class="form-group">
                            <label for="phone-number">Phone Number</label>
                            <div class="phone-input-container">
                                <select class="country-code" id="country-code">
                                    <option value="+91">+91 India</option>
                                    <option value="+1">+1 USA</option>
                                    <option value="+44">+44 UK</option>
                                    <option value="+61">+61 Australia</option>
                                    <option value="+86">+86 China</option>
                                </select>
                                <input type="tel" id="phone-number" class="phone-number" placeholder="10-digit number">
                            </div>
                        </div>
                        <button class="send-code-btn" id="send-code-btn" onclick="sendVerificationCode()">Send Verification Code</button>
                        <div class="form-group">
                            <label for="verification-code">Verification Code</label>
                            <input type="text" id="verification-code" placeholder="Enter 6-digit code">
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" placeholder="Enter your password">
                        </div>
                        <button class="verify-btn" onclick="verifyLogin()">Verify & Login</button>
                    </div>
                </div>

                <!-- Appearance Section -->
                <div class="settings-section">
                    <h3>Appearance</h3>
                    <div class="theme-options">
                        <div class="theme-option active" onclick="setTheme('system')">
                            <div class="option-text">üåô System</div>
                        </div>
                        <div class="theme-option" onclick="setTheme('light')">
                            <div class="option-text">‚òÄÔ∏è Light</div>
                        </div>
                        <div class="theme-option" onclick="setTheme('dark')">
                            <div class="option-text">üåô Dark</div>
                        </div>
                    </div>
                </div>

                <!-- Language Section -->
                <div class="settings-section">
                    <h3>Language</h3>
                    <div class="language-options">
                        <div class="language-option active" onclick="setLanguage('english')">
                            <div class="option-text">üåê English</div>
                        </div>
                        <div class="language-option" onclick="setLanguage('hindi')">
                            <div class="option-text">üåê Hindi</div>
                        </div>
                        <div class="language-option" onclick="setLanguage('spanish')">
                            <div class="option-text">üåê Spanish</div>
                        </div>
                    </div>
                </div>

                <!-- Logout Section -->
                <div class="settings-section">
                    <button class="logout-btn" onclick="logout()">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay for sidebar -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleChatHistory()"></div>

    <!-- Profile Dropdown Menu -->
    <div class="profile-dropdown" id="profile-dropdown">
        <button class="dropdown-item" onclick="openAccountSettings()">
            <div class="dropdown-icon">üë§</div>
            <div>Account Settings</div>
        </button>
        <button class="dropdown-item" onclick="openAppearanceSettings()">
            <div class="dropdown-icon">üåô</div>
            <div>Appearance</div>
        </button>
        <button class="dropdown-item" onclick="openLanguageSettings()">
            <div class="dropdown-icon">üåê</div>
            <div>Language</div>
        </button>
        <button class="dropdown-item logout" onclick="logout()">
            <div class="dropdown-icon">üö™</div>
            <div>Logout</div>
        </button>
    </div>

    <!-- Chat Context Menu -->
    <div class="chat-context-menu" id="chat-context-menu">
        <button class="context-menu-item" onclick="pinChat()">
            <div class="icon">üìå</div>
            <div>Pin Chat</div>
        </button>
        <button class="context-menu-item" onclick="renameChat()">
            <div class="icon">‚úèÔ∏è</div>
            <div>Rename</div>
        </button>
        <button class="context-menu-item delete" onclick="deleteChat()">
            <div class="icon">üóëÔ∏è</div>
            <div>Delete</div>
        </button>
    </div>

    <!-- Upload Options -->
    <div class="upload-options" id="upload-options">
        <button class="upload-option" onclick="uploadFiles()">
            <div class="icon">üìÑ</div>
            <div>Upload Files</div>
        </button>
        <button class="upload-option" onclick="uploadImage()">
            <div class="icon">üñºÔ∏è</div>
            <div>Upload Image</div>
        </button>
        <button class="upload-option" onclick="openNativeCamera()">
            <div class="icon">üì∑</div>
            <div>Take Photo</div>
        </button>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="file-input" accept=".pdf,.doc,.docx,.txt,.zip,.rar" multiple style="display: none;">
    <input type="file" id="image-input" accept="image/*" multiple style="display: none;">
    <input type="file" id="camera-input" accept="image/*" capture="camera" style="display: none;">

    <!-- Top Bar -->
    <div class="top-bar">
        <button class="menu-btn" onclick="toggleChatHistory()">
            ‚ò∞
        </button>
        
        <div class="app-title">
            <span class="hari-text">Hari AI</span>
            <input type="text" id="conversation-title" value="New Chat" placeholder="Chat Name" onchange="saveChatTitle()" style="display: none;">
        </div>
        
        <button class="new-chat-btn" onclick="createNewChat(true)" title="New Chat">
            <span class="star-icon">‚òÖ</span>
        </button>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="history-header">
                <h3>Chat History</h3>
                <div class="header-actions">
                    <button class="sidebar-profile-btn" onclick="toggleProfileDropdown()">
                        <div class="sidebar-user-icon">üë§</div>
                    </button>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="search-input" placeholder="Search chats..." oninput="filterChatHistory(this.value)">
                    <div class="search-icon">üîç</div>
                </div>
            </div>
            
            <div class="chat-list" id="chat-history">
                <!-- Chat history will be loaded here -->
            </div>
            
            <div class="stats" id="chat-stats">
                <!-- Stats will be shown here -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat">
            <!-- Chat Messages Area -->
            <div id="chat-messages" class="chat-messages">
                <!-- Messages will appear here -->
            </div>

            <!-- Input Area -->
            <div class="input-container" id="input-container">
                <div class="input-wrapper">
                    <div class="input-row">
                        <textarea id="user-input" placeholder="Type a message..." autocomplete="off" rows="1"></textarea>
                        
                        <div class="action-buttons">
                            <!-- + Button for upload options -->
                            <button class="icon-btn" id="upload-btn" onclick="toggleUploadOptions()" title="Add attachment">
                                <span class="plus-icon">+</span>
                            </button>
                            
                            <!-- Voice support button with ‚Ç¨ symbol -->
                            <button class="voice-btn" id="voice-btn" onclick="toggleVoiceInput()" title="Voice Input">
                                ‚Ç¨
                            </button>
                            
                            <button id="send-btn" onclick="sendMessage()">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // AI Class
        class HariAI {
            constructor() {
                this.conversationCount = 0;
            }

            getResponse(userInput) {
                this.conversationCount++;
                const cleanInput = userInput.toLowerCase().trim();

                if (this.conversationCount === 1) {
                    return "Hello! I'm Hari AI, your helpful assistant. How can I help you today?";
                }

                if (this.isGreeting(cleanInput)) {
                    const greetings = [
                        "Hello! Nice to chat with you!",
                        "Hi there! How can I assist you?",
                        "Greetings! What would you like to discuss?",
                    ];
                    return this.randomChoice(greetings);
                }

                const responses = [
                    "That's interesting! Tell me more about that.",
                    "I understand. What specific information are you looking for?",
                    "Great point! How can I help you explore this further?",
                    "Thanks for sharing! What would you like to know about this?"
                ];
                return this.randomChoice(responses);
            }

            isGreeting(text) {
                const greetings = ['hello', 'hi', 'hey', 'hii'];
                return greetings.some(greeting => text.includes(greeting));
            }

            randomChoice(array) {
                return array[Math.floor(Math.random() * array.length)];
            }
        }

        // App State
        const ai = new HariAI();
        let currentChatId = null;
        let chatHistory = [];
        let filteredChats = [];
        let isUploadOptionsVisible = false;
        let isProfileDropdownVisible = false;
        let isTyping = false;
        let longPressTimer = null;
        let selectedChatId = null;
        let isVoiceActive = false;
        let recognition = null;

        // Initialize App
        function init() {
            console.log("Initializing app...");
            loadChatHistory();
            setupAutoResize();
            setupFileInputs();
            setupClickOutsideListener();
            setupLongPress();
            setupVoiceRecognition();
            
            // Create initial chat if no chats exist
            if (chatHistory.length === 0) {
                console.log("No chats found, creating initial chat...");
                createNewChat(false);
            } else {
                // Load the most recent chat
                console.log("Loading existing chats...");
                loadChat(chatHistory[0].id);
            }
            
            console.log("App initialized successfully!");
        }

        // Voice Recognition Setup
        function setupVoiceRecognition() {
            // Check if browser supports speech recognition
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    console.log("Voice recognition started");
                    document.getElementById('voice-btn').classList.add('active');
                    document.getElementById('voice-indicator').classList.add('visible');
                    isVoiceActive = true;
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('user-input').value = transcript;
                    console.log("Voice input:", transcript);
                    
                    // Auto-send the message after voice input
                    setTimeout(() => {
                        sendMessage();
                    }, 500);
                };
                
                recognition.onerror = function(event) {
                    console.error("Speech recognition error:", event.error);
                    stopVoiceRecognition();
                    
                    if (event.error === 'not-allowed') {
                        alert('Microphone access denied. Please allow microphone access to use voice input.');
                    }
                };
                
                recognition.onend = function() {
                    console.log("Voice recognition ended");
                    stopVoiceRecognition();
                };
            } else {
                console.log("Speech recognition not supported in this browser");
                document.getElementById('voice-btn').style.display = 'none';
            }
        }

        function stopVoiceRecognition() {
            document.getElementById('voice-btn').classList.remove('active');
            document.getElementById('voice-indicator').classList.remove('visible');
            isVoiceActive = false;
        }

        // Voice Input Toggle - FIXED VERSION
        function toggleVoiceInput() {
            console.log("Voice button clicked");
            
            if (!recognition) {
                alert("Voice recognition is not supported in your browser");
                return;
            }
            
            if (isVoiceActive) {
                recognition.stop();
                stopVoiceRecognition();
            } else {
                try {
                    recognition.start();
                    console.log("Starting voice recognition...");
                } catch (error) {
                    console.error("Error starting voice recognition:", error);
                    alert("Error starting voice recognition. Please try again.");
                }
            }
        }

        // Profile Dropdown Functions
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profile-dropdown');
            if (isProfileDropdownVisible) {
                dropdown.classList.remove('visible');
            } else {
                dropdown.classList.add('visible');
            }
            isProfileDropdownVisible = !isProfileDropdownVisible;
        }

        function hideProfileDropdown() {
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.classList.remove('visible');
            isProfileDropdownVisible = false;
        }

        // Account Settings Functions
        function openAccountSettings() {
            hideProfileDropdown();
            const accountSettings = document.getElementById('account-settings');
            accountSettings.classList.add('visible');
        }

        function openAppearanceSettings() {
            hideProfileDropdown();
            const accountSettings = document.getElementById('account-settings');
            accountSettings.classList.add('visible');
            // Scroll to appearance section
            setTimeout(() => {
                document.querySelector('.settings-content').scrollTop = 300;
            }, 100);
        }

        function openLanguageSettings() {
            hideProfileDropdown();
            const accountSettings = document.getElementById('account-settings');
            accountSettings.classList.add('visible');
            // Scroll to language section
            setTimeout(() => {
                document.querySelector('.settings-content').scrollTop = 500;
            }, 100);
        }

        function closeAccountSettings() {
            const accountSettings = document.getElementById('account-settings');
            accountSettings.classList.remove('visible');
        }

        function sendVerificationCode() {
            const countryCode = document.getElementById('country-code').value;
            const phoneNumber = document.getElementById('phone-number').value;
            
            if (!phoneNumber || phoneNumber.length !== 10) {
                alert('Please enter a valid 10-digit phone number');
                return;
            }
            
            const fullNumber = countryCode + phoneNumber;
            
            // Simulate sending verification code
            const sendCodeBtn = document.getElementById('send-code-btn');
            sendCodeBtn.disabled = true;
            sendCodeBtn.textContent = 'Sending...';
            
            setTimeout(() => {
                sendCodeBtn.disabled = false;
                sendCodeBtn.textContent = 'Send Verification Code';
                alert(`Verification code sent to ${fullNumber}\nDemo Code: 123456`);
            }, 2000);
        }

        function verifyLogin() {
            const countryCode = document.getElementById('country-code').value;
            const phoneNumber = document.getElementById('phone-number').value;
            const code = document.getElementById('verification-code').value;
            const password = document.getElementById('password').value;
            
            const fullNumber = countryCode + phoneNumber;
            
            if (!phoneNumber || phoneNumber.length !== 10) {
                alert('Please enter a valid 10-digit phone number');
                return;
            }
            
            if (!code || code.length !== 6) {
                alert('Please enter a valid 6-digit verification code');
                return;
            }
            
            if (!password) {
                alert('Please enter your password');
                return;
            }
            
            // Simulate verification
            if (code === '123456' && password.length >= 6) {
                alert(`Login successful for ${fullNumber}!`);
                closeAccountSettings();
                
                // Update profile icon to show logged in state
                document.querySelector('.sidebar-user-icon').textContent = '‚úì';
                document.querySelector('.sidebar-user-icon').style.background = '#10b981';
            } else {
                alert('Invalid verification code or password. Please try again.');
            }
        }

        function setTheme(theme) {
            // Remove active class from all theme options
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Add active class to selected theme
            event.target.closest('.theme-option').classList.add('active');
            
            // Apply theme (you can implement actual theme switching here)
            console.log('Theme set to:', theme);
            
            // Show confirmation
            alert(`Theme changed to ${theme} mode`);
        }

        function setLanguage(language) {
            // Remove active class from all language options
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Add active class to selected language
            event.target.closest('.language-option').classList.add('active');
            
            // Apply language (you can implement actual language switching here)
            console.log('Language set to:', language);
            
            // Show confirmation
            alert(`Language changed to ${language}`);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear any login data
                document.getElementById('phone-number').value = '';
                document.getElementById('verification-code').value = '';
                document.getElementById('password').value = '';
                
                // Reset profile icon
                document.querySelector('.sidebar-user-icon').textContent = 'üë§';
                document.querySelector('.sidebar-user-icon').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                
                alert('Logged out successfully!');
                hideProfileDropdown();
            }
        }

        function setupAutoResize() {
            const textarea = document.getElementById('user-input');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        function setupFileInputs() {
            // File input setup
            const fileInput = document.getElementById('file-input');
            fileInput.addEventListener('change', handleFileUpload);
            
            // Image input setup
            const imageInput = document.getElementById('image-input');
            imageInput.addEventListener('change', handleImageUpload);
            
            // Camera input setup
            const cameraInput = document.getElementById('camera-input');
            cameraInput.addEventListener('change', handleCameraCapture);
        }

        function setupClickOutsideListener() {
            // Close upload options when clicking outside
            document.addEventListener('click', function(event) {
                const uploadOptions = document.getElementById('upload-options');
                const uploadBtn = document.getElementById('upload-btn');
                const contextMenu = document.getElementById('chat-context-menu');
                const profileDropdown = document.getElementById('profile-dropdown');
                const profileBtn = document.querySelector('.sidebar-profile-btn');
                const voiceBtn = document.getElementById('voice-btn');
                
                if (isUploadOptionsVisible && 
                    !uploadOptions.contains(event.target) && 
                    !uploadBtn.contains(event.target)) {
                    hideUploadOptions();
                }
                
                // Close context menu when clicking outside
                if (!event.target.closest('.chat-item') && !contextMenu.contains(event.target)) {
                    hideContextMenu();
                }
                
                // Close profile dropdown when clicking outside
                if (isProfileDropdownVisible && 
                    !profileDropdown.contains(event.target) && 
                    !profileBtn.contains(event.target)) {
                    hideProfileDropdown();
                }
            });
        }

        function setupLongPress() {
            const chatList = document.getElementById('chat-history');
            
            chatList.addEventListener('touchstart', handleTouchStart);
            chatList.addEventListener('touchend', handleTouchEnd);
            chatList.addEventListener('mousedown', handleMouseDown);
            chatList.addEventListener('mouseup', handleMouseUp);
            chatList.addEventListener('mouseleave', handleMouseUp);
        }

        function handleTouchStart(e) {
            const chatItem = e.target.closest('.chat-item');
            if (chatItem) {
                selectedChatId = parseInt(chatItem.getAttribute('data-chat-id'));
                startLongPressTimer();
            }
        }

        function handleTouchEnd() {
            clearLongPressTimer();
        }

        function handleMouseDown(e) {
            if (e.button === 0) { // Left click only
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    selectedChatId = parseInt(chatItem.getAttribute('data-chat-id'));
                    startLongPressTimer();
                }
            }
        }

        function handleMouseUp() {
            clearLongPressTimer();
        }

        function startLongPressTimer() {
            longPressTimer = setTimeout(() => {
                showContextMenu();
            }, 1000); // 1 second
        }

        function clearLongPressTimer() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        function showContextMenu() {
            const contextMenu = document.getElementById('chat-context-menu');
            const chatItem = document.querySelector(`.chat-item[data-chat-id="${selectedChatId}"]`);
            
            if (chatItem) {
                const rect = chatItem.getBoundingClientRect();
                contextMenu.style.top = `${rect.bottom + 5}px`;
                contextMenu.style.left = `${rect.left}px`;
                contextMenu.classList.add('visible');
            }
        }

        function hideContextMenu() {
            const contextMenu = document.getElementById('chat-context-menu');
            contextMenu.classList.remove('visible');
            selectedChatId = null;
        }

        function pinChat() {
            if (selectedChatId) {
                const chat = chatHistory.find(c => c.id === selectedChatId);
                if (chat) {
                    chat.pinned = !chat.pinned;
                    saveChatHistory();
                    renderChatHistory();
                    hideContextMenu();
                }
            }
        }

        function renameChat() {
            if (selectedChatId) {
                const chat = chatHistory.find(c => c.id === selectedChatId);
                if (chat) {
                    const newTitle = prompt('Enter new chat name:', chat.title);
                    if (newTitle && newTitle.trim()) {
                        chat.title = newTitle.trim();
                        if (currentChatId === selectedChatId) {
                            document.getElementById('conversation-title').value = chat.title;
                        }
                        saveChatHistory();
                        renderChatHistory();
                    }
                    hideContextMenu();
                }
            }
        }

        function deleteChat() {
            if (selectedChatId && confirm('Are you sure you want to delete this chat?')) {
                chatHistory = chatHistory.filter(c => c.id !== selectedChatId);
                filteredChats = filteredChats.filter(c => c.id !== selectedChatId);
                
                if (currentChatId === selectedChatId) {
                    if (chatHistory.length > 0) {
                        loadChat(chatHistory[0].id);
                    } else {
                        createNewChat(false);
                    }
                }
                
                saveChatHistory();
                renderChatHistory();
                updateStats();
                hideContextMenu();
            }
        }

        // Upload Functions
        function toggleUploadOptions(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const uploadOptions = document.getElementById('upload-options');
            const uploadBtn = document.getElementById('upload-btn');
            
            if (isUploadOptionsVisible) {
                hideUploadOptions();
            } else {
                showUploadOptions();
            }
        }

        function showUploadOptions() {
            const uploadOptions = document.getElementById('upload-options');
            const uploadBtn = document.getElementById('upload-btn');
            
            uploadOptions.classList.add('visible');
            uploadBtn.classList.add('active');
            isUploadOptionsVisible = true;
        }

        function hideUploadOptions() {
            const uploadOptions = document.getElementById('upload-options');
            const uploadBtn = document.getElementById('upload-btn');
            
            uploadOptions.classList.remove('visible');
            uploadBtn.classList.remove('active');
            isUploadOptionsVisible = false;
        }

        function uploadFiles() {
            hideUploadOptions();
            document.getElementById('file-input').click();
        }

        function uploadImage() {
            hideUploadOptions();
            document.getElementById('image-input').click();
        }

        function openNativeCamera() {
            hideUploadOptions();
            document.getElementById('camera-input').click();
        }

        // File Upload Handler
        function handleFileUpload(event) {
            console.log("File upload triggered", event.target.files);
            const files = event.target.files;
            if (files.length > 0) {
                for (let file of files) {
                    processFileUpload(file);
                }
                // Reset input for next upload
                event.target.value = '';
            }
        }

        function processFileUpload(file) {
            console.log("Processing file:", file.name);
            
            // Format file size
            const fileSize = formatFileSize(file.size);
            
            // Create file item with actions
            const fileHTML = `
                <div class="file-item">
                    <div class="file-icon">üìÑ</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${fileSize}</div>
                    </div>
                </div>
            `;
            
            // Add file message to chat
            addMessage('user', `üìÅ <strong>Uploaded file:</strong> ${file.name}`);
            addMessage('user', fileHTML, false);
            
            setTimeout(() => {
                const response = `I've received your file "${file.name}". I can help you analyze or work with this document. What would you like me to do with it?`;
                addMessage('ai', response);
                saveChatHistory();
            }, 1000);
        }

        function handleImageUpload(event) {
            console.log("Image upload triggered", event.target.files);
            const files = event.target.files;
            if (files.length > 0) {
                for (let file of files) {
                    processImageUpload(file);
                }
                // Reset input for next upload
                event.target.value = '';
            }
        }

        function processImageUpload(file) {
            console.log("Processing image:", file.name);
            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log("Image loaded successfully");
                
                // Create image with actions
                const imageHTML = `
                    <div style="margin: 10px 0;">
                        <img src="${e.target.result}" class="uploaded-image" alt="${file.name}" style="max-width: 300px; border-radius: 8px; margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    </div>
                `;
                
                // Add image message to chat
                addMessage('user', `üñºÔ∏è <strong>Uploaded image:</strong> ${file.name}`);
                addMessage('user', imageHTML, false);
                
                setTimeout(() => {
                    const response = `I can see the image "${file.name}" you've uploaded! It looks great. How would you like me to help you analyze or work with this image?`;
                    addMessage('ai', response);
                    saveChatHistory();
                }, 1000);
            };
            
            reader.onerror = function(e) {
                console.error("Error reading image file:", e);
                addMessage('user', `‚ùå Error uploading image: ${file.name}`);
            };
            
            reader.readAsDataURL(file);
        }

        function handleCameraCapture(event) {
            console.log("Camera capture triggered", event.target.files);
            const file = event.target.files[0];
            if (file) {
                processCameraCapture(file);
                // Reset input for next capture
                event.target.value = '';
            }
        }

        function processCameraCapture(file) {
            console.log("Processing camera capture:", file.name);
            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log("Camera image loaded successfully");
                const imageHTML = `
                    <div style="margin: 10px 0;">
                        <img src="${e.target.result}" class="uploaded-image" alt="Captured photo" style="max-width: 300px; border-radius: 8px; margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    </div>
                `;
                
                // Add camera message to chat
                addMessage('user', `üì∑ <strong>Captured a photo</strong>`);
                addMessage('user', imageHTML, false);
                
                setTimeout(() => {
                    const response = `Great photo! I can see the image you've captured. How would you like me to help you with this?`;
                    addMessage('ai', response);
                    saveChatHistory();
                }, 1000);
            };
            
            reader.onerror = function(e) {
                console.error("Error reading camera file:", e);
                addMessage('user', `‚ùå Error processing captured photo`);
            };
            
            reader.readAsDataURL(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function toggleChatHistory() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.toggle('visible');
            overlay.classList.toggle('visible');
            
            document.body.style.overflow = sidebar.classList.contains('visible') ? 'hidden' : '';
            
            // Clear search when opening sidebar
            if (sidebar.classList.contains('visible')) {
                document.getElementById('search-input').value = '';
                filterChatHistory('');
            }
        }

        function createNewChat(showToast = true) {
            console.log("Creating new chat...");
            
            // Generate unique ID based on timestamp to avoid conflicts
            currentChatId = Date.now();
            
            // Get the next chat number (unlimited)
            const nextChatNumber = chatHistory.length + 1;
            const title = `Chat ${nextChatNumber.toString().padStart(3, '0')}`;
            
            const newChat = {
                id: currentChatId,
                title: title,
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                messages: [],
                pinned: false,
                created: new Date().toISOString()
            };
            
            // Add to beginning of array (most recent first)
            chatHistory.unshift(newChat);
            filteredChats = [...chatHistory];
            
            // Update UI
            document.getElementById('conversation-title').value = title;
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('user-input').value = '';
            
            // Reset textarea height
            document.getElementById('user-input').style.height = 'auto';
            
            // Update chat list
            renderChatHistory();
            
            // Add welcome message
            addWelcomeMessage();
            
            // Update stats
            updateStats();
            
            // Save to localStorage
            saveChatHistory();
            
            console.log("New chat created:", newChat);
        }

        function filterChatHistory(searchTerm) {
            const searchLower = searchTerm.toLowerCase().trim();
            console.log("Searching for:", searchLower);
            
            if (searchLower === '') {
                filteredChats = [...chatHistory];
            } else {
                filteredChats = chatHistory.filter(chat => {
                    // Search in title
                    if (chat.title.toLowerCase().includes(searchLower)) {
                        return true;
                    }
                    
                    // Search in messages
                    if (chat.messages && chat.messages.length > 0) {
                        return chat.messages.some(msg => {
                            const content = msg.content || msg.text || '';
                            return content.toLowerCase().includes(searchLower);
                        });
                    }
                    
                    return false;
                });
            }
            
            console.log("Found", filteredChats.length, "chats");
            renderChatHistory();
        }

        function loadChatHistory() {
            console.log("Loading chat history from localStorage...");
            
            // Load from localStorage if available
            const savedChats = localStorage.getItem('hariChatHistory');
            if (savedChats) {
                try {
                    const parsedChats = JSON.parse(savedChats);
                    chatHistory = Array.isArray(parsedChats) ? parsedChats : [];
                    
                    console.log(`Loaded ${chatHistory.length} chats from storage`);
                    
                    // Ensure we have a valid currentChatId
                    if (chatHistory.length > 0 && !currentChatId) {
                        currentChatId = chatHistory[0].id;
                    }
                } catch (e) {
                    console.error('Error loading chat history:', e);
                    chatHistory = [];
                }
            } else {
                console.log("No saved chats found in localStorage");
                chatHistory = [];
            }
            
            filteredChats = [...chatHistory];
            renderChatHistory();
            updateStats();
        }

        function saveChatHistory() {
            try {
                localStorage.setItem('hariChatHistory', JSON.stringify(chatHistory));
                console.log(`Saved ${chatHistory.length} chats to localStorage`);
            } catch (e) {
                console.error('Error saving chat history:', e);
            }
        }

        function renderChatHistory() {
            const historyContainer = document.getElementById('chat-history');
            historyContainer.innerHTML = '';
            
            if (filteredChats.length === 0) {
                historyContainer.innerHTML = '<div class="no-results">No chats found</div>';
                return;
            }
            
            const sortedChats = [...filteredChats].sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return new Date(b.created) - new Date(a.created);
            });
            
            sortedChats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${chat.pinned ? 'pinned' : ''} ${chat.id === currentChatId ? 'active' : ''}`;
                chatItem.setAttribute('data-chat-id', chat.id);
                
                const messageCount = chat.messages ? chat.messages.length : 0;
                
                chatItem.innerHTML = `
                    <div class="chat-title">
                        ${chat.pinned ? 'üìå' : ''} ${chat.title}
                    </div>
                    <div class="chat-time">${chat.timestamp} ‚Ä¢ ${messageCount} messages</div>
                `;
                
                // FIXED: Properly bind the click event to load the chat
                chatItem.addEventListener('click', function(e) {
                    console.log("Chat clicked:", chat.id);
                    loadChat(chat.id);
                });
                
                historyContainer.appendChild(chatItem);
            });
        }

        function updateStats() {
            const statsElement = document.getElementById('chat-stats');
            const totalChats = chatHistory.length;
            const totalMessages = chatHistory.reduce((total, chat) => total + (chat.messages ? chat.messages.length : 0), 0);
            const pinnedChats = chatHistory.filter(chat => chat.pinned).length;
            
            statsElement.innerHTML = `
                ${totalChats} chats ‚Ä¢ ${totalMessages} messages ‚Ä¢ ${pinnedChats} pinned
            `;
        }

        function loadChat(chatId) {
            console.log("Loading chat:", chatId);
            const chat = chatHistory.find(c => c.id === chatId);
            if (chat) {
                currentChatId = chatId;
                document.getElementById('conversation-title').value = chat.title;
                document.getElementById('chat-messages').innerHTML = '';
                
                // Load messages
                if (chat.messages && chat.messages.length > 0) {
                    chat.messages.forEach(msg => {
                        addMessage(msg.sender, msg.content || msg.text, false);
                    });
                } else {
                    addWelcomeMessage();
                }
                
                // Update chat history display
                renderChatHistory();
                
                // Close sidebar on mobile
                if (window.innerWidth < 768) {
                    toggleChatHistory();
                }
                
                console.log("Chat loaded successfully:", chat.title);
            } else {
                console.error("Chat not found:", chatId);
            }
        }

        function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';
            
            // Disable send button while processing
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = '...';
            
            // Show typing indicator
            showTypingIndicator();
            
            setTimeout(() => {
                // Hide typing indicator
                hideTypingIndicator();
                
                const response = ai.getResponse(message);
                addMessage('ai', response);
                
                // Re-enable send button
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
                
                // Save chat history after sending message
                saveChatHistory();
                updateStats();
            }, 1000 + Math.random() * 1000);
        }

        function showTypingIndicator() {
            if (isTyping) return;
            
            const chat = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="avatar ai-avatar">AI</div>
                <div class="sender-name">Hari AI</div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            chat.appendChild(typingDiv);
            chat.scrollTop = chat.scrollHeight;
            isTyping = true;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            isTyping = false;
        }

        function addMessage(sender, content, saveToHistory = true) {
            const chat = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${sender}-message`;
            
            const avatar = sender === 'ai' ? 
                '<div class="avatar ai-avatar">AI</div>' : 
                '<div class="avatar user-avatar">You</div>';
            
            const senderName = sender === 'ai' ? 'Hari AI' : 'You';
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    ${avatar}
                    <div class="sender-name">${senderName}</div>
                </div>
                <div class="message-content">${content}</div>
            `;
            
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
            
            if (saveToHistory && currentChatId) {
                const currentChat = chatHistory.find(c => c.id === currentChatId);
                if (currentChat) {
                    if (!currentChat.messages) {
                        currentChat.messages = [];
                    }
                    currentChat.messages.push({ 
                        sender, 
                        content,
                        text: content,
                        timestamp: new Date().toISOString()
                    });
                }
            }
        }

        function addWelcomeMessage() {
            addMessage('ai', "Hello! I'm Hari AI, your intelligent assistant. I can help you with questions, creative tasks, problem-solving, and much more. What would you like to explore today?");
        }

        // Event Listeners
        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize app
        window.onload = init;
    </script>
</body>
</html>
